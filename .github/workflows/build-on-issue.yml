name: Build Resume from Issue
on:
  issues:
    types: [opened, edited]

jobs:
  render-and-reply:
    if: contains(github.event.issue.labels.*.name, 'build-request')
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # --- 替換掉出錯的解析步驟 ---
      - name: Extract Gist URL from Issue Body
        id: extract
        shell: bash
        run: |
          # 使用 grep 尋找 Gist URL 欄位下方的網址
          # 因為 Issue Form 的格式很固定，網址通常會出現在 ### Gist Raw URL 標題之後
          # 我們抓取以 https://gist.githubusercontent.com 開頭的字串
          GIST_URL=$(echo "${{ github.event.issue.body }}" | grep -oP 'https://gist\.githubusercontent\.com/[^\s\)]+')
          
          if [ -z "$GIST_URL" ]; then
            echo "Error: No valid Gist URL found."
            exit 1
          fi
          
          echo "url=$GIST_URL" >> $GITHUB_OUTPUT
          echo "Found URL: $GIST_URL"

      - name: Setup Quarto
        uses: quarto-dev/quarto-actions/setup@v2

      - name: Install TinyTeX
        run: quarto install tinytex

      - name: Download Gist
        run: |
          # 從上面的步驟讀取提取出來的網址
          curl -L -o resume.qmd "${{ steps.extract.outputs.url }}"

      - name: Render PDF
        run: quarto render resume.qmd --to pdf

      - name: Upload PDF
        id: upload
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.issue.number }}-resume-pdf
          path: resume.pdf

      - name: Reply to Issue
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.issue.number;
            const isSuccess = "${{ job.status }}" === "success";
            
            let message = "";
            if (isSuccess) {
              message = `### ✅ 履歷渲染成功！\n\nPDF 已生成，您可以前往 [Actions 頁面](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) 下載 Artifacts。`;
            } else {
              message = `### ❌ 履歷渲染失敗\n\n**可能原因：**\n1. 提供的連結不是 **Raw** 連結（須以 \`gist.githubusercontent.com\` 開頭）。\n2. Gist 內的 Markdown 語法不正確。\n3. 您可以查看 [執行日誌](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})。`;
            }

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: message
            });