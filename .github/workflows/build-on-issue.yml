name: Build Resume from Issue
on:
  issues:
    types: [opened, edited]

jobs:
  render-and-reply:
    if: contains(github.event.issue.labels.*.name, 'build-request')
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # --- 替換掉出錯的解析步驟 ---
      - name: Extract URL from Issue Body
        id: extract
        shell: bash
        run: |
          # 修正 Regex：支援 gist.githubusercontent 與 raw.githubusercontent
          # 並過濾掉潛在的 \r 或其他非 URL 字元
          RAW_BODY="${{ github.event.issue.body }}"
          
          # 這裡的 Regex 同時允許 gist 和 raw 兩種開頭
          EXTRACTED_URL=$(echo "$RAW_BODY" | grep -oP 'https://(gist|raw)\.githubusercontent\.com/[^\s\)\r]+' | head -1)
          
          if [ -z "$EXTRACTED_URL" ]; then
            echo "::error::找不到有效的 GitHub Raw URL。請確保網址是以 gist.githubusercontent.com 或 raw.githubusercontent.com 開頭。"
            exit 1
          fi
          
          # 輸出結果
          echo "url=$EXTRACTED_URL" >> $GITHUB_OUTPUT
          echo "✅ Successfully extracted URL: $EXTRACTED_URL"

      - name: Setup Quarto
        uses: quarto-dev/quarto-actions/setup@v2

      - name: Install TinyTeX
        run: quarto install tinytex

      - name: Download Gist
        run: |
          # 從上面的步驟讀取提取出來的網址
          curl -L -o resume.qmd "${{ steps.extract.outputs.url }}"

      - name: Render PDF
        run: quarto render resume.qmd --to pdf

      - name: Upload PDF
        id: upload
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.issue.number }}-resume-pdf
          path: resume.pdf

      - name: Reply to Issue
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.issue.number;
            const isSuccess = "${{ job.status }}" === "success";
            
            let message = "";
            if (isSuccess) {
              message = `### ✅ 履歷渲染成功！\n\nPDF 已生成，您可以前往 [Actions 頁面](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) 下載 Artifacts。`;
            } else {
              message = `### ❌ 履歷渲染失敗\n\n**可能原因：**\n1. 提供的連結不是 **Raw** 連結（須以 \`gist.githubusercontent.com\` 開頭）。\n2. Gist 內的 Markdown 語法不正確。\n3. 您可以查看 [執行日誌](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})。`;
            }

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: message
            });